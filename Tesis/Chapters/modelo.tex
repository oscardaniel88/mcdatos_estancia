\chapter{Diseño y Desarrollo}
\label{ch:modelo}

Este capítulo describirá el diseño y desarrollo del modelo de predicción de demanda y optimización de ingresos. El primer paso será presentar los \emph{data sets} utilizados. El segundo paso consistirá en describir el modelo, sus módulos, el funcionamiento y la arquitectura.

\section*{Data Sets}

\subsection*{Detalle de reservaciones}

Para la construcción del modelo de predicción de demanda se utilizaron tres data sets que contienen la información suficiente para poder hacer un pronóstico efectivo de la demanda de una propiedad.

El primer data set utilizado fue extraído directamente del sistema de gestión de propiedades y contiene información de todas las reservaciones marcadas en los libros de la propiedad, así como la información de las estancias pasadas. A continuación se presenta a detalle la información contenida en este data set, el diccionario de datos y un breve resumen de la información en cada una de las columnas.

\subsubsection*{Diccionario de Datos}

A continuación se presenta el diccionario de datos del \emph{data set} que contiene la información detallada de las reservaciones:

\begin{itemize}
  \item rsrv\_code: Código de confirmación de la reservación
  \item date\_create: Fecha y hora de creación de la reserva
  \item date\_in: Fecha de llegada a la propiedad
  \item date\_out: Fecha de salida de la propiedad
  \item nights: Número de noches de la reservación en el hotel
  \item prop\_code: Código de la propiedad dentro del sistema de gestión de propiedades
  \item mkt\_sgm: Segmento de mercado del huésped amparado en la reservación
  \item Dia\_Sem: Día de la semana de la fecha de llegada del huésped
  \item rate\_code: Código de tarifa
  \item bucket: Categoría de tarifa
  \item Ingresos: Ingresos obtenidos por la renta habitación de la reservación
  \item rsrv\_src: Canal de generación de la reservación
  \item rsrv\_type: Tipo de reservación
  \item room\_type: Tipo de habitación
  \item PAX: Número de personas amparadas por la reservación
\end{itemize}

\subsubsection*{Resumen de datos}

\begin{verbatim}
##    rsrv_code        date_create                 
##  Min.   :6265739   Min.   :2016-07-20 18:31:59  
##  1st Qu.:7499788   1st Qu.:2017-03-27 10:10:09  
##  Median :7999769   Median :2017-06-30 12:12:57  
##  Mean   :8007253   Mean   :2017-06-27 13:38:02  
##  3rd Qu.:8505582   3rd Qu.:2017-09-27 13:22:36  
##  Max.   :9053354   Max.   :2018-01-01 03:08:21  
##     date_in                   
##  Min.   :2017-01-01 00:00:00  
##  1st Qu.:2017-04-04 00:00:00  
##  Median :2017-07-06 00:00:00  
##  Mean   :2017-07-06 02:18:17  
##  3rd Qu.:2017-10-08 00:00:00  
##  Max.   :2017-12-31 00:00:00  
##     date_out                       nights 
##  Min.   :2017-01-02 00:00:00   Min.   :1  
##  1st Qu.:2017-04-05 00:00:00   1st Qu.:1  
##  Median :2017-07-07 00:00:00   Median :1  
##  Mean   :2017-07-07 02:18:17   Mean   :1  
##  3rd Qu.:2017-10-09 00:00:00   3rd Qu.:1  
##  Max.   :2018-01-01 00:00:00   Max.   :1  
##   prop_code           mkt_sgm            Dia_Sem         
##  Length:44391       Length:44391       Length:44391      
##  Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character  
##                                                          
##                                                          
##                                                          
##   rate_code            bucket             Ingresos   
##  Length:44391       Length:44391       Min.   :   0  
##  Class :character   Class :character   1st Qu.:1200  
##  Mode  :character   Mode  :character   Median :1462  
##                                        Mean   :1449  
##                                        3rd Qu.:1658  
##                                        Max.   :3900  
##    rsrv_src          rsrv_type          room_type        
##  Length:44391       Length:44391       Length:44391      
##  Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character  
##                                                          
##                                                          
##                                                          
##       pax       
##  Min.   :0.000  
##  1st Qu.:1.000  
##  Median :1.000  
##  Mean   :1.271  
##  3rd Qu.:1.000  
##  Max.   :5.000
\end{verbatim}

Es importante resaltar que los datos fueron trabajados para presentarse de manera desagregada, es decir, si una reservación ampara una estancia de 5 noches, en el \emph{data set final} se presenta un registro por cada noche de la estancia, por ejemplo:

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{table}[H]
\centering\rowcolors{2}{gray!6}{white}

\begin{tabular}{r|l|l|l|r|l}
\hiderowcolors
\hline
rsrv\_code & date\_create & date\_in & date\_out & nights & room\_type\\
\hline
\showrowcolors
6265739 & 2016-07-20 18:31:59 & 2017-04-07 & 2017-04-08 & 1 & NSK\\
\hline
6265739 & 2016-07-20 18:31:59 & 2017-04-08 & 2017-04-09 & 1 & NSK\\
\hline
6265739 & 2016-07-20 18:31:59 & 2017-04-09 & 2017-04-10 & 1 & NSK\\
\hline
6265739 & 2016-07-20 18:31:59 & 2017-04-10 & 2017-04-11 & 1 & NSK\\
\hline
6265739 & 2016-07-20 18:31:59 & 2017-04-11 & 2017-04-12 & 1 & NSK\\
\hline
6265739 & 2016-07-20 18:31:59 & 2017-04-12 & 2017-04-13 & 1 & NSK\\
\hline
\end{tabular}
\rowcolors{2}{white}{white}
\end{table}
\end{knitrout}

Como se puede observar, el número de reservación es el mismo en los seis registros, lo mismo ocurre con la fecha de creación, las noches y el tipo de habitación, sin embargo, la fecha de entrada y la fecha de salida va cambiando en cada registro.

\subsubsection*{Curvas de Pickup}

Del data set anterior podemos obtener las curvas de pickup del hotel. Estas curvas describen el comportamiento de las reservaciones para la propiedad en cuestión ya que mediante ellas podemos saber con cuanto tiempo de anticipación los huéspedes comienzan a reservar una habitación en la propiedad. A continuación se muestran las curvas de pickup para esta propiedad:

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{Figures/pickup-1} 

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/pickupzoom-1} 

Analizando las gráficas presentadas anteriormente podemos concluír que la demanda de esta propiedad comienza 25 días antes de la llegada del huésped al hotel, e incrementa considerablemente 5 días antes de la llegada del huésped al hotel. Este dato nos indica que el huésped comienza a buscar una habitación dentro de esta propiedad en un lapso no mayor a 25 días antes de emprender su viaje.

Las curvas de \emph{pickup} son importantes dentro del proceso de toma de decisiones ya que le indican al equipo que gestiona la propiedad el tiempo de antelación con el cual deberían llevar a cabo las acciones necesarias para poder optimizar el ingreso generado por la renta de habitaciones.

\subsection*{Ocupación de la propiedad}

El segundo \emph{data set} con el que se trabajó contiene las líneas de tiempo de los níveles de ocupación de la propiedad. Este set de datos es de suma importancia ya que proporciona información relevante con respecto a las temporalidades del hotel, mismas que deben ser reflejadas en el resultado del modelo.

Las temporalidades del hotel pueden ser desde periodos con alta o baja ocupación, inclusive por día de la semana ya que al ser un hotel enfocado a viajes de negocio, se esperaría tener una alta ocupación los días laborales (Lunes a Jueves) y una baja ocupación los fines de semana (Viernes a Domingo).

A continuación se presentan un par de gráficas que describen el contenido del \emph{data set} en cuestión:

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/HabitacionesOcupadas-1} 

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{Figures/Ocupacion-1} 

Como se puede observar en las gráficas presentadas anteriormente, esta propiedad tiene niveles de ocupación alrededor del 75\% llegando en repetidas ocasiones al 100\% de ocupación. Las caídas en los níveles de ocupación ocurren los fines de semana, lo cual confirma que el mercado objetivo de la propiedad estudiada es el turismo de negocios.

A continuación se presenta una gráfica de níveles de ocupación por día de la semana:

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{Figures/Ocupacion_Dia_Semana-1}


\subsection*{Tarifa Promedio de la propiedad}

El tercer conjunto de datos utilizado contiene los valores de la tarifa promedio \emph{ADR: Average Daily Rate} en el tiempo. Estos datos fueron obtenidos directamente del PMS y es el resultado de sumar los ingresos generados por las habitaciones divididos por el número total de cuartos vendidos. 

A continuación se presenta la línea de tiempo con los valores para la tarifa promedio a lo largo del tiempo.

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/IndicadoresTarifaPromedio-1} 

De esta última gráfica se puede observar que los precios siguen una tendencia positiva con respecto al tiempo, a medida que pasa el tiempo, los precios incrementan, sin embargo podemos notar también que a medida que pasa el tiempo los precios varían más. Si contrastamos la información presentada en la gráfica de la tarifa promedo vs el tiempo y la presentada en la gráfica de ocupación vs el tiempo podemos ver que aunque los precios han aumentado en esta propiedad, las tendencias en los níveles de ocupación permanecen constantes.

\subsection*{Precios Públicos en el tiempo}

Como se mencionó anteriormente, una propiedad típicamente tiene diferentes precios disponibles para cada uno de los segmentos de mercado a los que atiende. La tarifa que se ofrece al público que llega al hotel sin una reservación previa se le conoce como \emph{tarifa pública} y generalmente es la tarifa con el precio mas alto de la cúal desprenden todas las demás tarifas, es decir, el conjunto de tarifas disponible en el hotel serán descuentos realizados sobre la \emph{tarifa pública}.

El tercer data set con el se trabajo el desarrollo del modelo contiene la información de las tarifas públicas para el hotel en cuestión y su competencia a lo largo del tiempo. Esto nos ayudará a conocer el precio del producto ofrecido en el mercado objetivo, de tal forma que los precios arrojados por el modelo se encuentren siempre dentro del mercado.

Los precios de la competencia fueron obtenidos de las páginas electrónicas de las agencias en línea, booking.com y expedia.com principalmente.

A continuación se presentan las líneas de tiempo con los precios públicos para el conjunto de propiedades.

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/PreciosGraf-1} 

En la gráfica anterior se puede observar que hay algunos datos atípicos ya que es poco probable encontrar habitaciones en este segmento de hoteles por arriba de los \$3,000 MXN. Para confirmar esto se realizó una gráfica de caja y bigotes (boxplot) en la cuál se puede observar a primera vista los datos atípicos contenidos en el \emph{data set}.

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/PreciosBoxPlot-1} 

Los datos atípicos fueron eliminados antes de proceder a trabajar con el módelo final.

\subsection*{Tipo de cambio}

El último \emph{data set} utilizado para la construcción del modelo contiene la información histórica de los tipos de cambio del peso frente al dólar.

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/TiposdeCambio-1} 

En el siguiente apartado detallaremos cómo se utilizaron los datos presentados para la construcción del modelo de predicción de demanda y maximización de ingresos.


\section*{Modelo de Predicción de Demanda}

El modelo de predicción de demanda toma como entrada los datos de las curvas de \emph{pickup} para el hotel para cada día del periodo estudiado. Estas curvas describen la velocidad con la que una propiedad vende su inventario para un día en específico de tal forma que el modelo propuesto pueda ajustar una curva que resuma el comportamiento de la propiedad en un día similar al estudiado y de esta forma se pueda generar unna predicción de los cuartos vendidos en la propiedad y los días de antelación con los que serán vendidos.

Este modelo está compuesto por dos módulos principales. El primero es una regresión \emph{Poisson} definida como $log(E(Y|X)) = \beta_0 + \beta_1X$, que se alimentará con las curvas de \emph{pickup} que describen el comportamiento del hotel. Cómo resultado de este módulo obtendremos un parámetro $\beta_0$ y un parámetro $\beta_1$ que describen la curva que mejor ajusta al \emph{pickup} del hotel.

A continuación se muestra un resumen del conjunto de datos que alimentan al primer módulo del modelo de predicción de demanda:

\begin{verbatim}
 prop_code date_create    date_in nights antelacion
1      CEINS  2017-03-25 2017-03-26      1          1
2      CEINS  2016-12-26 2017-01-01      3          6
3      CEINS  2016-12-26 2017-01-02      3          7
4      CEINS  2016-12-26 2017-01-05      1         10
5      CEINS  2016-12-26 2017-01-03      1          8
6      CEINS  2016-12-26 2017-01-04      1          9
7      CEINS  2016-12-26 2017-01-05      1         10
8      CEINS  2016-12-26 2017-01-01      1          6
9      CEINS  2016-12-26 2017-01-02      1          7
10     CEINS  2016-12-26 2017-01-03      1          8
11     CEINS  2016-12-26 2017-01-04      1          9
12     CEINS  2016-12-27 2017-01-02      1          6
13     CEINS  2016-12-27 2017-01-03      1          7
14     CEINS  2016-12-27 2017-01-03      1          7
15     CEINS  2016-12-27 2017-01-04      1          8
\end{verbatim}

Una vez obtenidos los parámetros $\beta_0$ y $\beta_1$ de la regresión \emph{Poisson}, se procede a generar predictores potenciales de la demanda a partir de los datos con los que contamos para este análisis.

Los predictores definidos son:

\begin{itemize}
  \item diaSem: Definido como factores que van de Lunes a Domingo
  \item Mes: Definido como factores que van de Enero a Diciembre
  \item Eventos: 1 si la plaza cuenta con algun evento social, deportivo, o de entretenimiento en esa fecha, 0 en caso contrario
  \item PT: Definido como la tarifa promedio de la propiedad dividida entre la tarifa promedio de la competencia
  \item TDC: El valor del peso frente al dólar para cada día
  \item $beta_0$: El parámetro $\beta_0$ obtenido de la regresión \emph{Poisson}
  \item $beta_1$: El parámetro $\beta_1$ obtenido de la regresión \emph{Poisson}
\end{itemize}

A continuación podemos observar la matriz de correlaciones de los predictores propuestos vs la ocupación de la propiedad (esto debe cambiar, se debe correlacionar los predictores vs la $\beta_0$ y $\beta_1$)

\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figures/Correlacion-1} 


Con estos predictores definidos se procede a alimentar una regresión lineal que calculará nuevos parámetros $\beta_{0*}$ y $\beta_{1*}$. A partir de estos nuevos parámetros se construyen las curvas de \emph{pickup} que ayuden a predecir la demanda de la propiedad en días futuros.

Una vez concluído el cálculo, se genera una matriz en la cuál se plasma la estimación del número de \emph{cuartos} que se venderán en una ventana futura:

\begin{verbatim}
          dia cn_predic
       <date>     <int>
1  2018-06-01        92
2  2018-06-02        78
3  2018-06-03        96
4  2018-06-04        99
5  2018-06-05       132
6  2018-06-06       151
7  2018-06-07       138
8  2018-06-08        88
9  2018-06-09        77
10 2018-06-10       109
\end{verbatim}

Esta matriz será la entrada del modelo que recomendará los precios por habitación para maximizar los ingresos de la propiedad.


\section*{Modelo de maximización de ingresos}

Una vez pronósticado el nível de ocupación para cada una de las propiedades de la cadena, se alimentó un modelo de pricing dinámico que entrega recomendaciones de precios para la tarifa pública tomando en cuenta la demanda pronósticada para cierto día del año.

Típicamente el gerente de la propiedad controla la cantidad de cuartos ofrecidos a diferentes precios, es decir, se asigna cierto número de cuartos a cada nível de tarifa de tal forma que cuando el inventario asignado al precio mas bajo se agota, se consume el inventario asignado al siguiente nivel de tarifa que será mayor al primer precio ofertado.

A continuación se muestra un esquema donde se ejemplifica la idea mencionada anteriormente:

\begin{figure}[!]
  \includegraphics[width=\linewidth]{Figures/buckets.png}
  \caption{Asignacion de inventario}
  \label{fig:Asignacion de Inventario}
\end{figure}

Como se puede observar, tenemos un inventario de 32 cuartos divido en 4 níveles de precios:
\begin{itemize}[noitemsep]
\item 12 cuartos son ofrecidos a un valor de 110 USD
\item 8 cuartos son ofrecidos a un valor de 120 USD
\item 7 cuartos son ofrecidos a un valor de 130 USD
\item 5 cuartos son ofrecidos a un valor de 155 USD
\end{itemize}

\subsection*{Formulación del modelo}

Un problema de maximización de ingresos es básicamente un problema de optimización sujeto a restricciones, en este caso, se quiere maximizar la siguiente función objetivo:
$$\sum_{n=0}^{n}p_i*o_i$$
En donde i es la índice de la noche, $p_i$ es el precio del cuarto para la i-ésima noche y $o_i$ es la ocupación pronósticada (demanda) para la i-ésima noche al precio $p_i$. Asumimos también que la función de la ocupación (demanda) está sujeta al precio bajo la siguiente relación:
$$o = o_{nominal} * (\frac{p}{p_{nominal}})^e$$
Donde $o_{nominal}$ corresponde a la ocupación pronosticada para una noche dada tomando como base un precio nominal ($p_{nominal}$). Para este caso el $p_{nominal}$ es igual a la tarifa pública promediada a lo largo del año. El valor de $e$ (elasticidad) toma un valor = -2. En otras palabras, $p$ incrementa en un 10\% y la demanda decrece cerca de un 20\%.

Existen las siguientes restricciones también: $$o_i \leq Capacidad\ \forall i$$ y $$p_i > 0\ \forall i$$

En otras palabras, la ocupación no puede exceder a la capacidad del hotel y los precios deben ser siempre mayores a cero.

Para poder hacer una asignación dinámica de los precios, evitando tener que correr el modelo conforme la información del hotel es actualizada, se partió el inventario en 4 níveles de disponiblidad (159,120,80 y 40 cuartos disponibles). Para cada nível de capacidad se resolvió la función objetivo para obtener 4 conjuntos de precios, de esta forma, el gerente de la propiedad puede saber a qué nível de precio debe subir la tarifa pública de la propiedad conforme las habitaciones disponibles decrecen.

El modelo de maximización de ingresos arroja como resultado una matriz de día vs precio por niveles de inventario. A continuación se muestra un ejemplo:

\begin{verbatim}
##            day       40       80       120       159
## 137 2018-05-17 1616.650 1374.773 1122.4972  975.1633
## 77  2018-03-18 1701.113 1675.709 1368.2105 1188.6253
## 52  2018-02-21 1666.334 1529.706 1248.9996 1085.0615
## 16  2018-01-16 1647.043 1463.557 1194.9895 1038.1406
## 24  2018-01-24 1702.217 1681.071 1372.5888 1192.4289
## 93  2018-04-03 1703.315 1686.416 1376.9532 1196.2205
## 78  2018-03-19 1621.479 1387.804 1133.1372  984.4067
## 167 2018-06-16 1498.239 1138.420  929.5160  807.5119
## 139 2018-05-19 1527.223 1184.905  967.4709  840.4850
## 174 2018-06-23 1518.070 1169.615  954.9869  829.6396
\end{verbatim}

\subsection*{Consideraciones del modelo}

Este modelo se formuló considerando los siguientes puntos:
\begin{itemize}[noitemsep]
  \item Se consideran estancias de una sola noche
  \item No se toman en cuenta reservaciones para grupos ni cancelaciones
  \item Asusmimos paridad de precios entre los canales, es decir, los precios no varían entre los canales de venta
  \item Se considera solamente un tipo de habitación, el incremento por cambio de habitación es un monto fijo conocido como gap
  \item Se asume un valor para la elasticidad (-2) que es un valor razonable para la industria
\end{itemize}

En el siguiente capítulo se discutirá acerca de la interpretación del modelo propuesto y los resultados obtenidos.
